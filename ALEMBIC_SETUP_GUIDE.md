# Alembic Setup and Migration Guide

This guide explains how to set up and use Alembic for database migrations in the notification system.

## Prerequisites

1. **Ensure your .env file is configured** with the correct database URL
2. **Install dependencies** for the service you want to migrate

## Setup Steps

### 1. Install Dependencies

For each service (user-service, template-service), install the required packages:

```bash
# Navigate to the service directory
cd user-service  # or template-service

# Create a virtual environment (recommended)
python3 -m venv venv

# Activate the virtual environment
source venv/bin/activate  # On macOS/Linux
# or
venv\Scripts\activate  # On Windows

# Install dependencies
pip install -r requirements.txt
```

### 2. Configure Environment Variables

Ensure your `.env` file exists at the root level with the correct database configuration:

```env
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/notifications
```

**Note:** The Alembic `env.py` files are configured to automatically read the DATABASE_URL from your app's config, which loads from `.env`.

### 3. Verify Alembic Configuration

The following files have been created for each service:

- `alembic.ini` - Main Alembic configuration file
- `alembic/env.py` - Environment configuration with async support
- `alembic/script.py.mako` - Template for migration scripts
- `alembic/versions/` - Directory for migration files

## Creating Migrations

### For User Service

```bash
cd user-service

# Make sure you're in the virtual environment
source venv/bin/activate

# Create an initial migration (autogenerate from models)
alembic revision --autogenerate -m "Initial migration - create users table"

# This will create a new file in user-service/alembic/versions/
```

### For Template Service

```bash
cd template-service

# Make sure you're in the virtual environment
source venv/bin/activate

# Create an initial migration (autogenerate from models)
alembic revision --autogenerate -m "Initial migration - create templates table"

# This will create a new file in template-service/alembic/versions/
```

## Running Migrations

### Apply Migrations (Upgrade)

```bash
# From within the service directory
cd user-service  # or template-service

# Apply all pending migrations
alembic upgrade head

# Or apply migrations one step at a time
alembic upgrade +1
```

### Rollback Migrations (Downgrade)

```bash
# Rollback one migration
alembic downgrade -1

# Rollback to a specific revision
alembic downgrade <revision_id>

# Rollback all migrations
alembic downgrade base
```

## Checking Migration Status

```bash
# Show current revision
alembic current

# Show migration history
alembic history

# Show pending migrations
alembic history --verbose
```

## Creating Manual Migrations

If you need to create a migration manually (not autogenerated):

```bash
# Create an empty migration
alembic revision -m "Add custom index"

# Edit the generated file in alembic/versions/
# Add your upgrade() and downgrade() logic
```

## Common Migration Operations

### Adding a Column

```python
def upgrade() -> None:
    op.add_column('users', sa.Column('phone_number', sa.String(), nullable=True))

def downgrade() -> None:
    op.drop_column('users', 'phone_number')
```

### Creating an Index

```python
def upgrade() -> None:
    op.create_index('idx_users_email', 'users', ['email'])

def downgrade() -> None:
    op.drop_index('idx_users_email')
```

### Altering a Column

```python
def upgrade() -> None:
    op.alter_column('users', 'name',
                    existing_type=sa.String(),
                    nullable=False)

def downgrade() -> None:
    op.alter_column('users', 'name',
                    existing_type=sa.String(),
                    nullable=True)
```

## Using Docker

If you're running the services in Docker, you can run migrations inside the container:

```bash
# Run migrations for user-service
docker-compose exec user-service alembic upgrade head

# Run migrations for template-service
docker-compose exec template-service alembic upgrade head
```

## Troubleshooting

### Issue: "No module named 'app'"

**Solution:** Ensure you're running alembic from the service root directory (where `alembic.ini` is located) and your virtual environment is activated.

### Issue: "Can't locate revision identified by 'xxxxx'"

**Solution:** This usually means the database migration table is out of sync. You can:

1. Check current state: `alembic current`
2. Stamp the database with the correct revision: `alembic stamp head`

### Issue: "Target database is not up to date"

**Solution:** Run `alembic upgrade head` to apply all pending migrations.

### Issue: Async engine errors

**Solution:** The `env.py` files are configured for async support. Ensure you have `asyncpg` installed and your DATABASE_URL uses `postgresql+asyncpg://`.

## Best Practices

1. **Always review autogenerated migrations** before applying them
2. **Test migrations in development** before applying to production
3. **Create descriptive migration messages** for easy identification
4. **Keep migrations small and focused** - one logical change per migration
5. **Include both upgrade() and downgrade()** functions
6. **Don't modify existing migrations** once they've been applied to production
7. **Version control your migrations** - commit them to git

## Complete Workflow Example

Here's a complete workflow for adding a new feature:

```bash
# 1. Activate virtual environment
cd user-service
source venv/bin/activate

# 2. Make changes to your models (e.g., app/models/user.py)
# Add new field: location = Column(String, nullable=True)

# 3. Create migration
alembic revision --autogenerate -m "Add location field to users"

# 4. Review the generated migration file in alembic/versions/

# 5. Apply the migration
alembic upgrade head

# 6. Verify the migration
alembic current

# 7. Test your application with the new field

# 8. If something goes wrong, rollback
alembic downgrade -1
```

## Integration with CI/CD

For automated deployments, add migration commands to your deployment scripts:

```bash
# In your deployment script
cd /path/to/service
source venv/bin/activate
alembic upgrade head
```

## Database URL Configuration

The system uses the following database URL format:

```
postgresql+asyncpg://username:password@host:port/database_name
```

Example:

```
postgresql+asyncpg://postgres:postgres@localhost:5432/notifications
```

For production, use strong passwords and secure connection strings.

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy 2.0 Documentation](https://docs.sqlalchemy.org/en/20/)
- [FastAPI with Alembic Guide](https://fastapi.tiangolo.com/tutorial/sql-databases/)
